<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ToolBox Hub â€” Advanced Habit Tracker (Pro)</title>
<meta name="description" content="Advanced Habit Tracker â€” unlimited habits, streaks, reminders, exports. ToolBox Hub PRO." />
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style type="text/css">
  :root {
    --bg-start: #fdf2f8; /* Softer, warmer start */
    --bg-end: #e0f2fe;   /* Softer, cooler end */
    --card-bg: #ffffff;
    --accent-start: #f87171; /* Slightly softer red */
    --accent-end: #60a5fa;   /* Slightly softer blue */
    --muted: #6b7280;    /* Darker muted text */
    --text-primary: #1f2937; /* Darker primary text */
    --glass: rgba(255, 255, 255, 0.6); /* More opaque glass effect */
    --success: #10b981;
    --danger: #ef4444;   /* More noticeable danger red */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  html, body {
    height: 100%;
    scroll-behavior: smooth;
  }

  body {
    margin: 0;
    background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    color: var(--text-primary);
    padding: 24px; /* Increased padding */
    display: flex;
    align-items: flex-start;
    justify-content: center;
    box-sizing: border-box; /* Ensure padding doesn't cause overflow */
  }

  .container {
    width: 100%;
    max-width: 1200px; /* Slightly wider container */
    padding: 0 12px; /* Inner padding for smaller screens */
  }

  header {
    display: flex;
    align-items: center;
    gap: 20px; /* Increased gap */
    margin-bottom: 24px; /* Increased margin */
    flex-wrap: wrap; /* Allow wrapping on smaller screens */
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 14px; /* Increased gap */
  }

  .logo {
    width: 60px; /* Slightly larger logo */
    height: 60px;
    border-radius: var(--radius-md);
    background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 20px; /* Slightly larger font */
    box-shadow: 0 8px 20px rgba(11, 18, 32, 0.1); /* Softer, larger shadow */
  }

  .title {
    font-size: 20px; /* Slightly larger title */
    font-weight: 700;
    color: var(--text-primary);
  }

  .subtitle {
    font-size: 14px; /* Slightly larger subtitle */
    color: var(--muted);
  }

  .nav {
    margin-left: auto;
    display: flex;
    gap: 12px; /* Increased gap */
    align-items: center;
    flex-wrap: wrap; /* Allow wrapping */
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px; /* Slightly more padding */
    border-radius: var(--radius-sm);
    background: var(--card-bg);
    border: 1px solid #e5e7eb; /* Lighter border */
    cursor: pointer;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(11, 18, 32, 0.05); /* Softer shadow */
    text-decoration: none;
    color: var(--text-primary);
    transition: all 0.2s ease-in-out; /* Smooth transitions */
  }

  .btn:hover {
    background: #f9fafb;
    border-color: #d1d5db;
    transform: translateY(-1px); /* Subtle lift effect */
    box-shadow: 0 6px 16px rgba(11, 18, 32, 0.08);
  }

  .pro-badge {
    background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
    color: white;
    padding: 6px 10px;
    border-radius: var(--radius-sm);
    font-weight: 700;
    font-size: 11px; /* Smaller badge text */
    letter-spacing: 0.5px;
  }

  main {
    display: grid;
    grid-template-columns: 1fr 420px;
    gap: 24px; /* Increased gap */
  }

  /* mobile first */
  @media (max-width: 900px) {
    main {
      grid-template-columns: 1fr;
      padding-bottom: 48px;
    }
    .sidebar {
      order: -1;
    }
    header {
      justify-content: space-between;
    }
    .nav {
      margin-left: 0;
      width: 100%;
      justify-content: flex-end;
      order: 1; /* Move nav below brand on small screens */
    }
    .container {
      padding: 0;
    }
    body {
      padding: 16px;
    }
  }

  /* Left panel (tracker) */
  .card {
    background: var(--card-bg);
    border-radius: var(--radius-lg); /* More rounded corners */
    padding: 20px; /* Increased padding */
    box-shadow: 0 10px 40px rgba(11, 18, 32, 0.08); /* Softer, larger shadow */
  }

  .controls {
    display: flex;
    gap: 10px; /* Increased gap */
    flex-wrap: wrap;
    margin-bottom: 16px; /* Increased margin */
    align-items: center;
  }

  .input, .select { /* Combined input and select styling */
    flex: 1;
    min-width: 160px; /* Slightly larger min-width */
    padding: 12px; /* Increased padding */
    border-radius: var(--radius-sm);
    border: 1px solid #d1d5db; /* Lighter border */
    font-size: 15px; /* Slightly larger font */
    color: var(--text-primary);
    background-color: #f9fafb; /* Light background for inputs */
    transition: all 0.2s ease-in-out;
  }

  .input:focus, .select:focus {
    border-color: var(--accent-end);
    box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2); /* Focus ring */
    outline: none;
    background-color: var(--card-bg);
  }

  .small.btn {
    padding: 8px 12px;
    font-size: 14px;
  }

  .habit-list {
    display: grid;
    gap: 12px; /* Increased gap */
    margin-top: 16px;
  }

  .habit {
    display: flex;
    align-items: center;
    gap: 12px; /* Increased gap */
    padding: 14px; /* Increased padding */
    border-radius: var(--radius-md);
    background: var(--glass); /* Use glass variable */
    border: 1px solid rgba(255, 255, 255, 0.2); /* Lighter border for glass */
    backdrop-filter: blur(5px); /* Add blur for glass effect */
    box-shadow: 0 2px 10px rgba(11, 18, 32, 0.03); /* Subtle inner shadow */
    transition: all 0.2s ease-in-out;
  }

  .habit:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(11, 18, 32, 0.05);
  }

  .habit .meta {
    flex: 1;
    min-width: 0;
  }

  .habit h4 {
    margin: 0;
    font-size: 17px; /* Slightly larger */
    font-weight: 600; /* Softer bold */
    color: var(--text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .habit p {
    margin: 4px 0 0; /* Adjusted margin */
    font-size: 13px;
    color: var(--muted);
  }

  .habit .actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .icon-btn {
    border: none;
    background: #e5e7eb; /* Light background for icon buttons */
    color: var(--text-primary);
    padding: 8px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 18px; /* Larger icons */
    transition: background 0.2s ease-in-out, transform 0.1s ease-in-out;
  }

  .icon-btn:hover {
    background: #d1d5db;
    transform: translateY(-1px);
  }

  .check-btn {
    background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
    color: white;
    padding: 10px 14px; /* More padding */
    border-radius: var(--radius-sm);
    font-weight: 600;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(var(--accent-end), 0.3); /* Accentuated shadow */
    transition: all 0.2s ease-in-out;
  }

  .check-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 6px 14px rgba(var(--accent-end), 0.4);
  }

  .check-btn.completed {
    background: var(--success);
    box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
  }

  .check-btn.completed:hover {
    box-shadow: 0 6px 14px rgba(16, 185, 129, 0.4);
  }

  /* Right sidebar */
  .sidebar .card {
    position: sticky;
    top: 24px; /* Adjusted sticky position */
  }

  .stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px; /* Increased gap */
    margin-bottom: 16px; /* Increased margin */
  }

  .stat {
    background: #f9fafb; /* Light background for stats */
    padding: 16px; /* Increased padding */
    border-radius: var(--radius-md);
    text-align: center;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle inner shadow */
  }

  .stat h3 {
    margin: 0;
    font-size: 22px; /* Larger stat numbers */
    font-weight: 700;
    color: var(--accent-end); /* Color primary stats */
  }

  .stat:nth-child(1) h3 { color: var(--accent-start); } /* Specific colors for variety */
  .stat:nth-child(2) h3 { color: var(--success); }
  .stat:nth-child(3) h3 { color: #facc15; } /* Yellow for average */
  .stat:nth-child(4) h3 { color: #8b5cf6; } /* Purple for streak */


  .stat p {
    margin: 4px 0 0;
    color: var(--muted);
    font-size: 13px;
  }

  canvas {
    width: 100% !important;
    height: 180px !important; /* Slightly taller chart */
    border-radius: var(--radius-md);
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.55));
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .footer-note {
    font-size: 13px;
    color: var(--muted);
    margin-top: 16px; /* Increased margin */
    line-height: 1.5;
  }

  /* Locked overlay */
  .locked {
    display: flex;
    gap: 16px; /* Increased gap */
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 48px; /* More padding */
    text-align: center;
  }
  .locked h2 {
    font-size: 24px;
    color: var(--text-primary);
    margin-bottom: 8px;
  }
  .locked p {
    margin: 0 0 16px; /* Increased margin */
    font-size: 16px;
    color: var(--muted);
    max-width: 400px;
  }

  .stripe-btn {
    background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
    color: white;
    padding: 14px 20px; /* More prominent button */
    border-radius: var(--radius-md);
    border: none;
    font-weight: 700;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    box-shadow: 0 6px 15px rgba(var(--accent-end), 0.3);
    transition: all 0.2s ease-in-out;
    font-size: 16px;
  }

  .stripe-btn:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 8px 18px rgba(var(--accent-end), 0.4);
  }

  /* tiny */
  .muted {
    color: var(--muted);
    font-size: 13px;
  }

  .small-txt {
    font-size: 12px;
    color: var(--muted);
  }

  /* responsive tweaks */
  @media (max-width: 600px) {
    .logo {
      width: 52px;
      height: 52px;
      font-size: 18px;
    }
    .title {
      font-size: 18px;
    }
    .input, .select {
      padding: 10px;
      min-width: unset;
      width: 100%;
    }
    .controls {
      flex-direction: column;
      align-items: stretch;
    }
    .btn {
      width: 100%;
      justify-content: center;
    }
    .habit .actions {
      flex-direction: column;
      gap: 6px;
    }
    .check-btn, .icon-btn {
      width: 100%;
      justify-content: center;
    }
    .habit {
      flex-wrap: wrap;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">TB</div>
        <div>
          <div class="title">ToolBox Hub <span class="pro-badge">PRO</span></div>
          <div class="subtitle">Advanced Habit Tracker</div>
        </div>
      </div>

      <nav class="nav">
        <a class="btn" href="https://omnitoolaz.com" target="_blank" rel="noopener noreferrer">Back to ToolBox Hub</a>
        <a id="customer-portal-link" class="btn" href="https://billing.stripe.com/p/login/dRm14p9vl1vD5U72dYbsc00" target="_blank" rel="noopener noreferrer">Manage Subscription</a>
        <button id="unlock-sample" class="btn" title="Set pro unlocked locally (dev)">Unlock (dev)</button>
      </nav>
    </header>

    <main>
      <section class="card" id="app">
        <div id="locked-screen" class="locked" style="display:none;">
          <h2>Advanced Habit Tracker â€” PRO</h2>
          <p>Unlock unlimited habits, smart reminders, streak analytics and export features.</p>
          <a id="go-pay" 
             class="stripe-btn" 
             href="https://buy.stripe.com/test_cNi00l9vl2zH1DR8Cmbsc02" 
             target="_blank" 
             rel="noopener noreferrer">
            Subscribe â‚¹299/month â€” Secure with Stripe
          </a>
          <p class="small-txt">After payment you will be redirected here for full access. Your purchase unlocks all pro tools.</p>
        </div>

        <div id="tracker-ui" style="display:none;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; flex-wrap: wrap;">
            <div>
              <h2 style="margin:0 0 8px 0; font-size: 24px;">My Habits</h2>
              <div class="muted" style="font-size: 15px;">Track daily consistency. Your progress is saved locally.</div>
            </div>
            <div class="pro-features-note small-txt" style="background: #e0f7fa; padding: 6px 12px; border-radius: var(--radius-sm); color: #00796b; font-weight: 600;">
                Pro features: reminders, exports, charts
            </div>
          </div>

          <div class="controls">
            <input id="habit-name" class="input" placeholder="Add a new habit (e.g., Read 20 pages)" />
            <select id="habit-frequency" class="select">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
            </select>
            <button id="add-habit" class="btn">Add Habit</button>
          </div>

          <div class="controls">
            <input id="search" class="input" placeholder="Search habits..." />
            <button id="export-btn" class="btn small">Export CSV</button>
            <label class="btn small" style="cursor:pointer;"><input id="import-file" type="file" accept=".csv" style="display:none">Import</label>
          </div>

          <div id="habit-list" class="habit-list"></div>

          <div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap; justify-content: flex-start;">
            <button id="clear-all" class="btn small">Clear All (dev)</button>
            <button id="request-notif" class="btn small">Enable Reminders</button>
            <button id="mark-today" class="btn small">Mark Today's Date</button>
          </div>

          <div class="footer-note">Tip: After successful Stripe payment, you can either redirect to this page with <code>?pro=1</code> or set <code>localStorage.pro_unlocked = "1"</code> from your server verification.</div>
        </div>
      </section>

      <aside class="sidebar">
        <div class="card">
          <h3 style="margin-top:0; font-size: 20px; color: var(--text-primary);">Progress Overview</h3>
          <div class="stats" style="margin-top:16px;">
            <div class="stat">
              <h3 id="total-habits">0</h3>
              <p class="muted">Total Habits</p>
            </div>
            <div class="stat">
              <h3 id="today-completed">0</h3>
              <p class="muted">Completed Today</p>
            </div>
            <div class="stat">
              <h3 id="avg-complete">0%</h3>
              <p class="muted">30-day Avg</p>
            </div>
            <div class="stat">
              <h3 id="longest-streak">0</h3>
              <p class="muted">Longest Streak</p>
            </div>
          </div>

          <h4 style="margin:16px 0 10px 0; font-size: 18px; color: var(--text-primary);">Last 30 Days</h4>
          <canvas id="chart"></canvas>

          <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; justify-content: flex-start;">
            <button id="import-sample" class="btn small">Load Sample Data</button>
            <button id="reset-stats" class="btn small">Reset Stats</button>
          </div>

          <p class="muted" style="margin-top:16px;">Local only: this demo stores data in your browser storage. For production, sync server-side or protect the page behind authenticated access after Stripe verification.</p>
        </div>
      </aside>
    </main>
  </div>

<script>
/*
  Advanced Habit Tracker (Pro)
  - Stores habits in localStorage under key "tb_habits"
  - Unlocking: if URL contains ?pro=1 OR localStorage.pro_unlocked === "1", the app UI shows.
  - REPLACE the two placeholder links below with your actual Stripe links.
*/

// âš ï¸ REPLACE THIS with your actual Stripe Payment Link (for new subscriptions)
const STRIPE_PAYMENT_LINK = "https://buy.stripe.com/test_cNi00l9vl2zH1DR8Cmbsc02"; 

// âš ï¸ REPLACE THIS with your Stripe Customer Portal Login Link (for existing customers to manage billing)
const STRIPE_PORTAL_LINK = "https://billing.stripe.com/p/login/dRm14p9vl1vD5U72dYbsc00"; 


// Utils
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,7);
const todayISO = (d = new Date()) => d.toISOString().slice(0,10);
const parseDate = s => new Date(s + 'T00:00:00');
const daysBetween = (a,b) => Math.round((b-a)/(24*3600*1000));

// storage helpers
function saveData(data){
  localStorage.setItem('tb_habits', JSON.stringify(data));
}
function loadData(){
  return JSON.parse(localStorage.getItem('tb_habits') || '[]');
}

// Chart data (simple)
function drawChart(percentageArray){
  const canvas = document.getElementById('chart');
  if(!canvas.getContext) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.clientWidth * devicePixelRatio;
  canvas.height = canvas.clientHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
  const w = canvas.clientWidth, h = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);

  // background gradient for bars
  const g = ctx.createLinearGradient(0,0,w,0);
  g.addColorStop(0, 'var(--accent-start)'); /* Use CSS variable */
  g.addColorStop(1, 'var(--accent-end)');   /* Use CSS variable */
  ctx.fillStyle = g;
  const barWidth = Math.max(4, (w - 12) / percentageArray.length - 2);
  percentageArray.forEach((p,i) => {
    const x = 6 + i*(barWidth+2);
    const barH = (p/100) * (h - 20);
    ctx.fillRect(x, h - 10 - barH, barWidth, barH);
  });

  // axis labels
  ctx.fillStyle = 'var(--muted)'; /* Use CSS variable */
  ctx.font = '12px Inter, system-ui'; /* Use Inter font */
  ctx.fillText('0%', 6, h - 2);
  ctx.fillText('100%', w - 36, 12);
}

// Core app
document.addEventListener('DOMContentLoaded', () => {
  const lockedScreen = document.getElementById('locked-screen');
  const trackerUI = document.getElementById('tracker-ui');
  const unlockDev = document.getElementById('unlock-sample');
  const customerPortalLink = document.getElementById('customer-portal-link');

  // Set the link dynamically (though it's already set in HTML, this is safer)
  customerPortalLink.href = STRIPE_PORTAL_LINK;
  
  // Also set the payment link dynamically
  document.getElementById('go-pay').href = STRIPE_PAYMENT_LINK;


  function isPro() {
    const q = new URLSearchParams(window.location.search);
    if (q.get('pro') === '1') {
      // If redirected with ?pro=1, save to local storage for future visits
      try { localStorage.setItem('pro_unlocked', '1'); } catch(e){}
      return true;
    }
    return localStorage.getItem('pro_unlocked') === '1';
  }

  function showGate(){
    if(isPro()){
      lockedScreen.style.display = 'none';
      trackerUI.style.display = 'block';
      // Show the "Manage Subscription" link only if Pro is unlocked
      customerPortalLink.style.display = 'inline-flex';
      renderAll();
    } else {
      lockedScreen.style.display = 'flex';
      trackerUI.style.display = 'none';
      // Hide the "Manage Subscription" link until Pro is unlocked
      customerPortalLink.style.display = 'none';
    }
  }

  // dev unlock (for testing, sets local storage)
  unlockDev.addEventListener('click', () => {
    localStorage.setItem('pro_unlocked', '1');
    alert('Pro unlocked locally for testing. Reloading...');
    // Re-check access and render UI
    showGate();
  });

  showGate();

  // UI elements
  const habitListEl = document.getElementById('habit-list');
  const nameInput = document.getElementById('habit-name');
  const freqInput = document.getElementById('habit-frequency');
  const addBtn = document.getElementById('add-habit');
  const searchInput = document.getElementById('search');
  const exportBtn = document.getElementById('export-btn');
  const importFile = document.getElementById('import-file');
  const totalHabitsEl = document.getElementById('total-habits');
  const todayCompletedEl = document.getElementById('today-completed');
  const avgCompleteEl = document.getElementById('avg-complete');
  const longestStreakEl = document.getElementById('longest-streak');
  const importSample = document.getElementById('import-sample');
  const clearAllBtn = document.getElementById('clear-all');
  const resetStatsBtn = document.getElementById('reset-stats');
  const requestNotif = document.getElementById('request-notif');
  const markTodayBtn = document.getElementById('mark-today');

  function getHabits(){
    return loadData();
  }

  function setHabits(data){
    saveData(data);
    renderAll();
  }

  function addHabit(name, freq){
    const data = getHabits();
    const note = { id: uid(), name: name.trim(), freq: freq || 'daily', createdAt: new Date().toISOString(), completed: {}, longestStreak: 0 };
    data.unshift(note);
    setHabits(data);
  }

  function editHabit(id, updates){
    const data = getHabits().map(h => h.id === id ? {...h, ...updates} : h);
    setHabits(data);
  }

  function removeHabit(id){
    const data = getHabits().filter(h => h.id !== id);
    setHabits(data);
  }

  function toggleComplete(id, dateISO){
    const data = getHabits().map(h => {
      if(h.id !== id) return h;
      const completed = {...h.completed};
      if(completed[dateISO]) delete completed[dateISO];
      else completed[dateISO] = true;
      return {...h, completed};
    });
    setHabits(data);
  }

  // Stats utilities
  function calcLongestStreak(completedDates){
    // completedDates: keys of dates where completed true
    const days = Object.keys(completedDates).sort();
    if(!days.length) return 0;
    let longest = 0, current = 1;
    for(let i=1;i<days.length;i++){
      const prev = parseDate(days[i-1]);
      const curr = parseDate(days[i]);
      if(daysBetween(prev, curr) === 1) current++; else { longest = Math.max(longest, current); current = 1; }
    }
    longest = Math.max(longest, current);
    return longest;
  }

  function compute30DayCompletionPercent(){
    const data = getHabits();
    const last30 = [];
    for(let i=29;i>=0;i--){
      const d = new Date(); d.setDate(d.getDate() - i);
      const iso = todayISO(d);
      last30.push(iso);
    }
    const result = last30.map(date => {
      let count = 0;
      data.forEach(h => { if(h.completed && h.completed[date]) count++; });
      return data.length ? Math.round((count/data.length) * 100) : 0;
    });
    return result;
  }

  function renderAll(){
    const data = getHabits();
    const filter = searchInput.value.trim().toLowerCase();
    habitListEl.innerHTML = '';
    const today = todayISO();
    let todayCompleted = 0;
    let longest = 0;
    data.forEach(h => {
      if(filter && !h.name.toLowerCase().includes(filter)) return;
      const doneToday = !!(h.completed && h.completed[today]);
      if(doneToday) todayCompleted++;
      longest = Math.max(longest, calcLongestStreak(h.completed || {}));

      const div = document.createElement('div');
      div.className = 'habit';
      if (doneToday) {
        div.classList.add('completed'); // Add a class for completed habits
      }

      const meta = document.createElement('div');
      meta.className = 'meta';
      const h4 = document.createElement('h4'); h4.textContent = h.name;
      const p = document.createElement('p'); p.textContent = `Frequency: ${h.freq} â€¢ Created: ${new Date(h.createdAt).toLocaleDateString()}`;

      meta.appendChild(h4); meta.appendChild(p);

      const actions = document.createElement('div'); actions.className = 'actions';

      const chk = document.createElement('button');
      chk.className = 'check-btn';
      if (doneToday) {
        chk.classList.add('completed'); // Add completed class to button as well
        chk.textContent = 'Completed';
      } else {
        chk.textContent = 'Mark Complete';
      }
      chk.addEventListener('click', () => toggleComplete(h.id, todayISO()));

      const edit = document.createElement('button');
      edit.className = 'icon-btn';
      edit.innerHTML = 'âœï¸'; // Pencil icon
      edit.title = 'Edit';
      edit.addEventListener('click', () => {
        const newName = prompt('Edit habit name', h.name);
        if(newName && newName.trim()) editHabit(h.id, { name: newName.trim() });
      });

      const del = document.createElement('button');
      del.className = 'icon-btn';
      del.innerHTML = 'ðŸ—‘ï¸'; // Trash can icon
      del.title = 'Delete';
      del.addEventListener('click', () => {
        if(confirm('Delete this habit?')) removeHabit(h.id);
      });

      actions.appendChild(chk);
      actions.appendChild(edit);
      actions.appendChild(del);

      div.appendChild(meta);
      div.appendChild(actions);
      habitListEl.appendChild(div);
    });

    totalHabitsEl.textContent = data.length;
    todayCompletedEl.textContent = todayCompleted;
    longestStreakEl.textContent = longest;

    // 30-day average
    const arr = compute30DayCompletionPercent();
    const avg = arr.reduce((a,b)=>a+b,0) / (arr.length || 1);
    avgCompleteEl.textContent = Math.round(avg) + '%';
    drawChart(arr);
  }

  // Add / Search / Export / Import
  addBtn.addEventListener('click', () => {
    const name = nameInput.value.trim();
    if(!name) return alert('Enter a habit name');
    addHabit(name, freqInput.value);
    nameInput.value = '';
  });

  nameInput.addEventListener('keydown', e => { if(e.key === 'Enter') addBtn.click(); });

  searchInput.addEventListener('input', () => renderAll());

  exportBtn.addEventListener('click', () => {
    const data = getHabits();
    if(!data.length) return alert('No habits to export');
    // CSV: id,name,freq,createdAt,completedDates(sep|),longest
    const rows = [['id','name','freq','createdAt','completed','longestStreak']];
    data.forEach(h => {
      const completed = Object.keys(h.completed || {}).join('|');
      rows.push([h.id, JSON.stringify(h.name), h.freq, h.createdAt, completed, h.longestStreak || 0]);
    });
    const csv = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'tb_habits_export.csv'; a.click();
    URL.revokeObjectURL(url);
  });

  importFile.addEventListener('change', (ev) => {
    const f = ev.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const txt = reader.result;
      // naive CSV parse
      const lines = txt.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const out = [];
      for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(',');
        const id = cols[0] || uid();
        const name = cols[1] ? JSON.parse(cols[1]) : ('Imported ' + id);
        const freq = cols[2] || 'daily';
        const createdAt = cols[3] || new Date().toISOString();
        const completed = {};
        if(cols[4]) cols[4].split('|').forEach(d => { if(d) completed[d] = true; });
        const longest = parseInt(cols[5]||'0',10);
        out.push({ id, name, freq, createdAt, completed, longestStreak: longest });
      }
      setHabits(out);
      alert('Import complete');
      importFile.value = '';
    };
    reader.readAsText(f);
  });

  importSample.addEventListener('click', () => {
    const sample = [
      { id: uid(), name: 'Read 20 pages', freq:'daily', createdAt:new Date().toISOString(), completed:{}, longestStreak:0 },
      { id: uid(), name: 'Morning Walk 20 min', freq:'daily', createdAt:new Date().toISOString(), completed:{}, longestStreak:0 },
      { id: uid(), name: 'Log Expenses', freq:'daily', createdAt:new Date().toISOString(), completed:{}, longestStreak:0 },
    ];
    // mark some previous completion to make chart interesting
    const d = new Date();
    for(let i=0;i<10;i++){
      const iso = todayISO(new Date(d.getFullYear(), d.getMonth(), d.getDate() - i));
      sample.forEach((h, idx) => {
        if(Math.random() > 0.4) h.completed[iso] = true;
      });
    }
    setHabits(sample);
  });

  clearAllBtn.addEventListener('click', () => {
    if(confirm('Clear all local data?')) { localStorage.removeItem('tb_habits'); renderAll(); }
  });

  resetStatsBtn.addEventListener('click', () => {
    const data = getHabits().map(h => ({ ...h, completed: {}, longestStreak: 0 }));
    setHabits(data);
  });

  requestNotif.addEventListener('click', async () => {
    if(!('Notification' in window)) return alert('Browser notifications not supported');
    if(Notification.permission === 'granted') return alert('Notifications already enabled');
    const res = await Notification.requestPermission();
    if(res === 'granted') alert('Notifications enabled. You will get reminders if scheduled.');
  });

  markTodayBtn.addEventListener('click', () => {
    // Mark all habits today (dev convenience)
    const data = getHabits().map(h => ({ ...h, completed: { ...(h.completed||{}), [todayISO()]: true } }));
    setHabits(data);
  });

  // Basic notification scheduler (simple demo)
  // For production, use Service Worker and server push for reliable reminders
  function scheduleDailyReminder(habit){
    if(!('Notification' in window)) return;
    if(Notification.permission !== 'granted') return;
    const title = 'Habit Reminder';
    const body = `Don't forget: ${habit.name}`;
    // Show immediately for demo
    new Notification(title, { body });
  }

  // On load, compute some derived properties for each habit
  function recalcDerived(){
    const data = getHabits().map(h => {
      const longest = calcLongestStreak(h.completed || {});
      return { ...h, longestStreak: longest };
    });
    setHabits(data);
  }

  // initial render
  renderAll();

  // small autosave on visibilitychange
  document.addEventListener('visibilitychange', () => {
    if(document.visibilityState === 'hidden') saveData(getHabits());
  });

  // periodic recalc & rerender (useful to update stats)
  setInterval(() => {
    recalcDerived();
    renderAll();
  }, 5000);
});
</script>
</body>
</html>

